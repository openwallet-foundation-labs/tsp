# 新功能现实世界应用示例

这三个新功能（关系状态机、重试机制、离线消息队列）共同构成了一个健壮的、可适应不稳定网络环境的通信系统基础。以下是一个现实世界中的应用示例，展示它们如何协同工作：

### 应用场景：智能家居控制系统 (Smart Home Control System)

假设你有一个 **智能手机 App (Controller)** 和一个 **智能门锁 (Device)**。它们通过 TSP 协议进行安全通信。

#### 1. 关系建立 (Relationship State Machine)
**场景**：你刚买了智能门锁，第一次用手机 App 配对。

*   **现实流程**：
    1.  你在 App 上点击“添加设备”，App 发送一个 `RequestRelationship` 消息给门锁。
    2.  **状态机作用**：App 的状态变为 `Unidirectional`（单向请求中），门锁收到后状态变为 `ReverseUnidirectional`。
    3.  门锁验证你的身份（例如按下物理按钮），然后发送 `AcceptRelationship`。
    4.  **状态机作用**：App 收到接受消息，状态变为 `Bidirectional`（双向已连接）。现在双方可以安全通信了。
*   **解决的问题**：如果你的配偶同时也在用他的手机 App 配对同一个门锁，状态机的 **并发处理 (Concurrency Handling)** 逻辑会确保只有一个请求能成功，或者根据 `thread_id` 规则有序解决冲突，避免门锁状态混乱。

#### 2. 自动重试 (Retry Mechanism)
**场景**：你回家走到门口，点击 App 上的“开锁”按钮。但是，你家门口的 Wi-Fi 信号刚好波动了一下，或者 4G 信号很差。

*   **现实流程**：
    1.  App 发送“开锁”指令（这是一个 TSP 消息）。
    2.  由于网络波动，消息没有发出去，或者门锁没收到。
    3.  **重试机制作用**：App 不会立刻报错说“开锁失败”。它会等待 500ms，然后自动重试。如果还不行，等待 750ms 再试。
    4.  在第二次重试时，网络恢复了，消息成功发送。门开了。
*   **用户体验**：你感觉不到网络出过问题，只觉得点了一下按钮，门就开了（可能稍微慢了 0.5 秒），而不是看到一个烦人的“连接超时，请重试”弹窗。

#### 3. 离线消息队列 (Offline Message Queue)
**场景**：你出门上班了，想远程授权给快递员一个临时密码。但是，你家的 Wi-Fi 路由器突然断电了，智能门锁处于离线状态。

*   **现实流程**：
    1.  你在公司用 App 发送了一个“设置临时密码：1234”的指令。
    2.  App 尝试连接门锁，发现连不上（Transport Error）。
    3.  **消息队列作用**：App 不会丢弃这个指令，而是将其放入 **离线消息队列**。
    4.  App 会在后台定期检查，或者当你回家手机连上家里 Wi-Fi 时，或者当门锁重新上线发送心跳包时，App 检测到连接恢复。
    5.  **队列刷新**：App 自动从队列中取出“设置临时密码”指令并发送出去。
*   **解决的问题**：确保关键指令（如授权、撤销权限）不会因为设备暂时离线而丢失。你不需要一直盯着 App 等设备上线再手动发送。

### 总结
*   **状态机** 确保了**“连接”**过程的逻辑正确和安全。
*   **重试机制** 解决了**“瞬时”**的网络问题。
*   **消息队列** 解决了**“长时间”**的离线问题。

这三者结合，让 TSP SDK 能够支撑起像智能家居、物联网 (IoT)、即时通讯 (IM) 等对可靠性要求较高的实际应用。
